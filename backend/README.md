# EarthFrame Backend

This project uses [Poetry](https://python-poetry.org/) for dependency management and [FastAPI](https://fastapi.tiangolo.com/) as the web framework.

---

## üöÄ Developer Quickstart

Get started in **five simple commands**:

```bash
# 1. Clone the repository
git clone https://github.com/<your-org>/earthframe.git
cd earthframe/backend

# 2. Install dependencies
make install

# 3. (Optional) Enter Poetry shell
make shell

# 4. Run the FastAPI development server
make reload

# 5. View API docs
open http://127.0.0.1:8000/docs
```

The API will be live at **[http://127.0.0.1:8000](http://127.0.0.1:8000)**, with Swagger UI at `/docs` and ReDoc at `/redoc`.

---

## Table of Contents

- [Setup Instructions](#setup-instructions)

  - [1. Install Poetry](#1-install-poetry)
  - [2. Install Dependencies](#2-install-dependencies)
  - [3. Activate the Poetry Shell (optional)](#3-activate-the-poetry-shell-optional)

- [üß∞ Makefile Commands](#-makefile-commands)

  - [Using the Makefile](#using-the-makefile)
  - [üîß Setup & Environment](#-setup--environment)
  - [üöÄ Development Server](#-development-server)
  - [üóÑÔ∏è Database Migrations (Alembic)](#Ô∏è-database-migrations-alembic)
  - [üßπ Code Quality](#-code-quality)
  - [üÜò Miscellaneous](#-miscellaneous)
  - [Example Workflow](#example-workflow)

- [Startup](#startup)

  - [1. Run FastAPI Application](#1-run-fastapi-application)
  - [2. API Documentation](#2-api-documentation)

- [Tech Stack Overview](#tech-stack-overview)

  - [Core Libraries](#core-libraries)
  - [Typical Flow](#typical-flow)
  - [Notes](#notes)

- [Managing the Backend](#managing-the-backend)

  - [Editing Models and Schemas](#editing-models-and-schemas)

- [License](#license)

---

## Setup Instructions

### 1. Install Poetry

If you don't have Poetry installed, run:

```bash
curl -sSL https://install.python-poetry.org | python3 -
```

Or follow the [official instructions](https://python-poetry.org/docs/#installation).

### 2. Install Dependencies

Navigate to the project directory and install dependencies:

```bash
cd /Users/vo13/repositories/earthframe/backend
poetry install
```

### 3. Activate the Poetry Shell (optional)

```bash
poetry shell
```

---

## üß∞ Makefile Commands

### Using the Makefile

To simplify development, this project includes a `Makefile` that wraps common commands (e.g., starting the server, running migrations, linting code).
You can always list available commands with:

```bash
make help
```

All commands run inside the Poetry environment automatically.

### üîß Setup & Environment

| Command        | Description                                          | Equivalent Command                                                                                                 |
| -------------- | ---------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| `make install` | Install all dependencies using Poetry.               | `poetry install`                                                                                                   |
| `make shell`   | Open a Poetry shell (optional).                      | `poetry shell`                                                                                                     |
| `make clean`   | Remove caches, build artifacts, and temporary files. | `find . -type d -name "__pycache__" -exec rm -rf {} +`<br>`find . -type d -name ".pytest_cache" -exec rm -rf {} +` |

### üöÄ Development Server

| Command       | Description                                                      | Equivalent Command                                                      |
| ------------- | ---------------------------------------------------------------- | ----------------------------------------------------------------------- |
| `make run`    | Start the FastAPI application.                                   | `poetry run uvicorn app.main:app --host 127.0.0.1 --port 8000`          |
| `make reload` | Start FastAPI with auto-reload (recommended during development). | `poetry run uvicorn app.main:app --reload --host 127.0.0.1 --port 8000` |

### üóÑÔ∏è Database Migrations (Alembic)

| Command                         | Description                                                              | Equivalent Command                                        |
| ------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------- |
| `make migrate m="Message"`      | Generate a new Alembic migration with an autogenerated diff and message. | `poetry run alembic revision --autogenerate -m "Message"` |
| `make upgrade`                  | Apply all pending migrations.                                            | `poetry run alembic upgrade head`                         |
| `make downgrade rev=<revision>` | Revert the database to a specific migration revision.                    | `poetry run alembic downgrade <revision>`                 |
| `make current`                  | Show the current migration version in the database.                      | `poetry run alembic current`                              |
| `make history`                  | List all migration scripts and their statuses.                           | `poetry run alembic history`                              |

### üßπ Code Quality

| Command       | Description                               | Equivalent Command              |
| ------------- | ----------------------------------------- | ------------------------------- |
| `make lint`   | Run Ruff linter on the codebase.          | `poetry run ruff check .`       |
| `make format` | Automatically fix lint issues using Ruff. | `poetry run ruff check . --fix` |

### üÜò Miscellaneous

| Command     | Description                                            | Equivalent Command                     |
| ----------- | ------------------------------------------------------ | -------------------------------------- |
| `make help` | Display all available commands and short descriptions. | _(Printed directly from the Makefile)_ |

### Example Workflow

```bash
# 1. Install dependencies
make install

# 2. Start the FastAPI server with live reload
make reload

# 3. Make model changes and generate a migration
make migrate m="Add user model"

# 4. Apply migrations
make upgrade

# 5. Check and fix code style
make lint
make format
```

---

## Startup

### 1. Run FastAPI Application

You can start the FastAPI server using [uvicorn](https://www.uvicorn.org/):

```bash
poetry run uvicorn app.main:app --reload
```

The API will be available at [http://127.0.0.1:8000](http://127.0.0.1:8000).

### 2. API Documentation

Once running, access the interactive docs at:

- Swagger UI: [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)
- ReDoc: [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)

---

## Tech Stack Overview

This backend uses the following core libraries:

### Core Libraries

- **FastAPI** ‚Äî the web framework.
  Handles routing, request/response lifecycle, dependency injection, security, and OpenAPI documentation.

  - **Directory**: `backend/app`

- **Pydantic** ‚Äî data validation & serialization.
  Defines models for request bodies, responses, and configuration. Ensures type safety and (de)serialization to/from JSON.

  - **Directory**: `backend/app/models`

- **SQLAlchemy** ‚Äî database ORM & toolkit.
  Provides a high-level interface to define tables/entities, compose queries, and manage sessions/transactions.

  - **Directory**: `backend/app/db`

- **Alembic** ‚Äî schema migrations for SQLAlchemy.
  Keeps the database schema versioned and synchronized across environments.

  - **Directory**: `backend/migrations`

### Typical Flow

1. **Client request** ‚Üí handled by FastAPI endpoint.
2. **Pydantic model** validates and parses the request payload.
3. **SQLAlchemy** session is used to query or update the database.
4. Results are mapped into a **Pydantic response model** and returned.
5. **Alembic migrations** are applied when the database schema evolves.

### Notes

- Keep **Pydantic models** (API schemas) separate from **SQLAlchemy models** (database schemas).
- Manage **SQLAlchemy sessions** per request to avoid leaks.
- Review **Alembic migrations** before applying, even if autogenerated.

---

## Managing the Backend

### Editing Models and Schemas

1. **Modify SQLAlchemy Models**

   - Navigate to `backend/app/models` and update or add new models.

2. **Update Pydantic Schemas**

   - Navigate to `backend/app/schemas` and update or create new Pydantic schemas.

3. **Generate and Apply Alembic Migrations**

   - Generate a new migration:

     ```bash
     poetry run alembic revision --autogenerate -m "Describe your migration"
     ```

   - Review the migration script under `backend/migrations/versions`.
   - Apply the migration:

     ```bash
     poetry run alembic upgrade head
     ```

4. **Test Changes**

   - Run the FastAPI application and test the endpoints.

---

**Notes:**

- Always review autogenerated migrations for accuracy before applying.
- Ensure the DB connection URL is configured correctly in `alembic.ini` or environment variables.
- Test database changes in a staging environment before deploying to production.

## License

For license information, see the [root LICENSE file](../LICENSE).
