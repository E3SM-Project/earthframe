# Earthframe Backend

This project uses [Poetry](https://python-poetry.org/) for dependency management and [FastAPI](https://fastapi.tiangolo.com/) as the web framework.

## Table of Contents

- [Setup Instructions](#setup-instructions)
  - [1. Install Poetry](#1-install-poetry)
  - [2. Install Dependencies](#2-install-dependencies)
  - [3. Activate the Poetry Shell (optional)](#3-activate-the-poetry-shell-optional)
- [Startup](#startup)
  - [1. Run FastAPI Application](#1-run-fastapi-application)
  - [2. API Documentation](#2-api-documentation)
- [Tech Stack Overview](#tech-stack-overview)
  - [Core Libraries](#core-libraries)
  - [Typical Flow](#typical-flow)
  - [Notes](#notes)
- [Managing the Backend](#managing-the-backend)
  - [Editing Models and Schemas](#editing-models-and-schemas)
- [Helpful Alembic Commands](#helpful-alembic-commands)

## Setup Instructions

### 1. Install Poetry

If you don't have Poetry installed, run:

```bash
curl -sSL https://install.python-poetry.org | python3 -
```

Or follow the [official instructions](https://python-poetry.org/docs/#installation).

### 2. Install Dependencies

Navigate to the project directory and install dependencies:

```bash
cd /Users/vo13/repositories/earthframe/backend
poetry install
```

### 3. Activate the Poetry Shell (optional)

```bash
poetry shell
```

## Startup

### 1. Run FastAPI Application

You can start the FastAPI server using [uvicorn](https://www.uvicorn.org/):

```bash
poetry run uvicorn app.main:app --reload
```

The API will be available at [http://127.0.0.1:8000](http://127.0.0.1:8000).

### 2. API Documentation

Once running, access the interactive docs at:

- Swagger UI: [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)
- ReDoc: [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)

---

For more details, see the [Poetry documentation](https://python-poetry.org/docs/) and [FastAPI documentation](https://fastapi.tiangolo.com/).

## Tech Stack Overview

This backend uses the following core libraries:

### Core Libraries

- **FastAPI** — the web framework.
  Handles routing, request/response lifecycle, dependency injection, security, and OpenAPI documentation.

  - **Directory**: `backend/app`

- **Pydantic** — data validation & serialization.
  Defines models for request bodies, responses, and configuration. Ensures type safety and (de)serialization to/from JSON.

  - **Directory**: `backend/app/models`

- **SQLAlchemy** — database ORM & toolkit.
  Provides a high-level interface to define tables/entities, compose queries, and manage sessions/transactions.

  - **Directory**: `backend/app/db`

- **Alembic** — schema migrations for SQLAlchemy.
  Keeps the database schema versioned and synchronized across environments. Supports both autogenerated and manual migrations.
  - **Directory**: `backend/migrations`

### Typical Flow

1. **Client request** → handled by FastAPI endpoint.
2. **Pydantic model** validates and parses the request payload.
3. **SQLAlchemy** session is used to query or update the database.
4. Results are mapped into a **Pydantic response model** and returned.
5. **Alembic migrations** are applied when the database schema evolves.

### Notes

- Keep **Pydantic models** (API schemas) separate from **SQLAlchemy models** (database schemas).
- Manage **SQLAlchemy sessions** per request to avoid leaks.
- Review **Alembic migrations** before applying, even if autogenerated.

## Managing the Backend

### Editing Models and Schemas

1. **Modify SQLAlchemy Models**

   - Navigate to the `backend/app/models` directory and locate the relevant SQLAlchemy model file.
   - Update or add new models as needed. For example, to add a new column to a table, modify the corresponding class definition.

2. **Update Pydantic Schemas**

   - Navigate to the `backend/app/schemas` directory.
   - Update or create new Pydantic schemas to reflect the changes in your API schema.

3. **Generate and Apply Alembic Migrations**

   - After editing the SQLAlchemy models, generate a new migration script:

     ```bash
     poetry run alembic revision --autogenerate -m "Describe your migration"
     ```

   - Review the autogenerated migration script in the `backend/migrations/versions` directory.
   - Apply the migration to the database:

     ```bash
     poetry run alembic upgrade head
     ```

4. **Test Changes**

   - Verify that the changes work as expected by running the FastAPI application and testing the endpoints.

## Helpful Alembic Commands

Here are some common commands to manage database migrations with Alembic:

| **Command**                                                               | **Description**                                                                                 | **Example**                                                                     |
| ------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| `poetry run alembic revision --autogenerate -m "Describe your migration"` | Generate a new migration script based on changes in your SQLAlchemy models.                     | `poetry run alembic revision --autogenerate -m "Add new column to users table"` |
| `poetry run alembic upgrade head`                                         | Apply all unapplied migrations to the database.                                                 | `poetry run alembic upgrade head`                                               |
| `poetry run alembic downgrade -1`                                         | Revert the last applied migration.                                                              | `poetry run alembic downgrade -1`                                               |
| `poetry run alembic downgrade <revision_id>`                              | Revert to a specific migration version. Replace `<revision_id>` with the desired revision hash. | `poetry run alembic downgrade abc123`                                           |
| `poetry run alembic current`                                              | View the current migration version in the database.                                             | `poetry run alembic current`                                                    |
| `poetry run alembic history`                                              | List all migration scripts and their statuses.                                                  | `poetry run alembic history`                                                    |

### Notes

- Always review autogenerated migrations for accuracy before applying them.
- Ensure the database connection URL is correctly configured in `alembic.ini` or environment variables.
- Use `poetry shell` to simplify command execution if the Poetry shell is activated.
- Keep migrations organized and ensure they are applied in the correct order across environments.
- Test database changes in a staging environment before deploying to production.
