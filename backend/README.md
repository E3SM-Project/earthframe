# EarthFrame Backend

This project uses [Poetry](https://python-poetry.org/) for dependency management and [FastAPI](https://fastapi.tiangolo.com/) as the web framework.

---

## üöÄ Developer Quickstart

Get started in **five simple commands**:

```bash
# 1. Clone the repository
git clone https://github.com/<your-org>/earthframe.git
cd earthframe/backend

# 2. Install dependencies
make install

# 3. (Optional) Enter Poetry shell
make shell

# 4. Run the FastAPI development server
make reload

# 5. View API docs
open http://127.0.0.1:8000/docs
```

The API will be live at **[http://127.0.0.1:8000](http://127.0.0.1:8000)**, with Swagger UI at `/docs` and ReDoc at `/redoc`.

---

## Table of Contents

- [Setup Instructions](#setup-instructions)
- [üß∞ Makefile Commands](#-makefile-commands)
- [Startup](#startup)
- [Tech Stack Overview](#tech-stack-overview)
- [Managing the Backend](#managing-the-backend)

  - [Editing Models and Schemas](#editing-models-and-schemas)
  - [PostgreSQL Database Setup](#postgresql-database-setup)

- [Containerization and Deployment](#containerization-and-deployment)
- [License](#license)

---

## Setup Instructions

### 1. Install Poetry

If you don't have Poetry installed, run:

```bash
curl -sSL https://install.python-poetry.org | python3 -
```

Or follow the [official instructions](https://python-poetry.org/docs/#installation).

### 2. Install Dependencies

Navigate to the project directory and install dependencies:

```bash
cd /Users/vo13/repositories/earthframe/backend
poetry install
```

### 3. Create a Local Environment File

A template file is provided for convenience:

```bash
cp .env.example .env
```

Then, edit `.env` to ensure the settings match your local development environment ‚Äî particularly the `DATABASE_URL` if running PostgreSQL locally.

> ‚ö†Ô∏è Never commit your `.env` file ‚Äî it may contain secrets or local overrides.

### 4. Activate the Poetry Shell (optional)

```bash
poetry shell
```

---

## üß∞ Makefile Commands

### Using the Makefile

To simplify development, this project includes a `Makefile` that wraps common commands (e.g., starting the server, running migrations, linting code).

```bash
make help
```

All commands run inside the Poetry environment automatically.

### üîß Setup & Environment

| Command        | Description                                          | Equivalent Command                                                                                                 |
| -------------- | ---------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| `make install` | Install all dependencies using Poetry.               | `poetry install`                                                                                                   |
| `make shell`   | Open a Poetry shell (optional).                      | `poetry shell`                                                                                                     |
| `make clean`   | Remove caches, build artifacts, and temporary files. | `find . -type d -name "__pycache__" -exec rm -rf {} +`<br>`find . -type d -name ".pytest_cache" -exec rm -rf {} +` |

### üöÄ Development Server

| Command       | Description                                                      | Equivalent Command                                                      |
| ------------- | ---------------------------------------------------------------- | ----------------------------------------------------------------------- |
| `make run`    | Start the FastAPI application.                                   | `poetry run uvicorn app.main:app --host 127.0.0.1 --port 8000`          |
| `make reload` | Start FastAPI with auto-reload (recommended during development). | `poetry run uvicorn app.main:app --reload --host 127.0.0.1 --port 8000` |

### üóÑÔ∏è Database Migrations (Alembic)

| Command                         | Description                                                              | Equivalent Command                                        |
| ------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------- |
| `make migrate m="Message"`      | Generate a new Alembic migration with an autogenerated diff and message. | `poetry run alembic revision --autogenerate -m "Message"` |
| `make upgrade`                  | Apply all pending migrations.                                            | `poetry run alembic upgrade head`                         |
| `make downgrade rev=<revision>` | Revert the database to a specific migration revision.                    | `poetry run alembic downgrade <revision>`                 |
| `make current`                  | Show the current migration version in the database.                      | `poetry run alembic current`                              |
| `make history`                  | List all migration scripts and their statuses.                           | `poetry run alembic history`                              |

### üßπ Code Quality

| Command       | Description                               | Equivalent Command              |
| ------------- | ----------------------------------------- | ------------------------------- |
| `make lint`   | Run Ruff linter on the codebase.          | `poetry run ruff check .`       |
| `make format` | Automatically fix lint issues using Ruff. | `poetry run ruff check . --fix` |

### üÜò Miscellaneous

| Command     | Description                                            | Equivalent Command                     |
| ----------- | ------------------------------------------------------ | -------------------------------------- |
| `make help` | Display all available commands and short descriptions. | _(Printed directly from the Makefile)_ |

---

## Startup

### 1. Run FastAPI Application

```bash
poetry run uvicorn app.main:app --reload
```

API available at [http://127.0.0.1:8000](http://127.0.0.1:8000)

### 2. API Documentation

- Swagger UI: [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)
- ReDoc: [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)

---

## Tech Stack Overview

- **FastAPI** ‚Äî Web framework for async Python APIs.
- **Pydantic** ‚Äî Data validation and serialization.
- **SQLAlchemy** ‚Äî ORM and database toolkit.
- **Alembic** ‚Äî Schema migrations.
- **Poetry** ‚Äî Dependency management and packaging.

**Typical Flow:**

1. FastAPI endpoint handles a request.
2. Pydantic validates input/output.
3. SQLAlchemy queries the database.
4. Alembic manages schema versioning.

---

## Managing the Backend

### Editing Models and Schemas

1. Modify SQLAlchemy models (`backend/app/models`).
2. Update Pydantic schemas (`backend/app/schemas`).
3. Generate and apply Alembic migrations:

   ```bash
   poetry run alembic revision --autogenerate -m "Describe your migration"
   poetry run alembic upgrade head
   ```

---

## PostgreSQL Database Setup

To set up a local PostgreSQL database using Docker:

### 1. Run the PostgreSQL Container

```bash
docker run --name earthframe-db \
  -e POSTGRES_USER=earthframe \
  -e POSTGRES_PASSWORD=earthframe \
  -e POSTGRES_DB=earthframe \
  -v earthframe_pgdata:/var/lib/postgresql/data \
  -p 5432:5432 \
  -d postgres:16
```

**Explanation:**

- `POSTGRES_USER`, `POSTGRES_PASSWORD`, and `POSTGRES_DB` define credentials and the default DB.
- `-v earthframe_pgdata:/var/lib/postgresql/data` ensures data persists between restarts.
- `-p 5432:5432` maps the port for local access.
- `postgres:16` pins a stable version and avoids breaking changes from future major releases.

### 2. Verify the Database is Running

```bash
docker ps
```

If you don‚Äôt see the container, check logs:

```bash
docker logs earthframe-db
```

### 3. Connect to the Database

Using `psql`:

```bash
psql -h localhost -U earthframe -d earthframe
```

Or through a GUI like TablePlus / DBeaver:

- Host: `127.0.0.1`
- Port: `5432`
- User: `earthframe`
- Password: `earthframe`
- Database: `earthframe`

### 4. Update the Application Configuration

In `.env`:

```env
DATABASE_URL=postgresql+psycopg://earthframe:earthframe@localhost:5432/earthframe
```

> üí° If using async SQLAlchemy, change to `postgresql+asyncpg://`.

### 5. Run Migrations

```bash
make upgrade
```

This applies all migrations and initializes the schema.

---

## üê≥ Containerization and Deployment

EarthFrame‚Äôs backend and database will soon be **fully containerized** to simplify deployment.
A `docker-compose.yml` will define:

- The FastAPI backend
- The PostgreSQL service
- Shared volumes and environment configuration

This will enable a single-command setup like:

```bash
docker compose up -d
```

Stay tuned ‚Äî containerization scripts will be added in an upcoming release.

---

## License

For license information, see the [root LICENSE file](../LICENSE).
